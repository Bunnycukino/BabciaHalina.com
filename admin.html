<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administratora | Babcia Halina</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 100px auto 50px;
            padding: 2rem;
        }
        
        .admin-header {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .admin-header h1 {
            color: white;
            margin-bottom: 0.5rem;
        }
        
        .admin-nav {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .admin-nav-btn {
            flex: 1;
            min-width: 150px;
            padding: 1rem;
            background: white;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .admin-nav-btn:hover,
        .admin-nav-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }
        
        .admin-section {
            display: none;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
        }
        
        .admin-section.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .image-preview {
            max-width: 300px;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
        }
        
        .product-list {
            display: grid;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .product-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--color-background-alt);
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .product-item:hover {
            box-shadow: var(--shadow-sm);
        }
        
        .product-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .product-item-info {
            flex: 1;
        }
        
        .product-item-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-edit,
        .btn-delete {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-edit {
            background: var(--color-accent);
            color: white;
        }
        
        .btn-delete {
            background: var(--color-error);
            color: white;
        }
        
        .btn-edit:hover {
            opacity: 0.8;
        }
        
        .btn-delete:hover {
            opacity: 0.8;
        }
        
        .logout-btn {
            position: fixed;
            top: 90px;
            right: 2rem;
            padding: 0.7rem 1.5rem;
            background: var(--color-error);
            color: white;
            border-radius: 25px;
            font-weight: 600;
            z-index: 100;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--color-background-alt);
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            border: 2px solid var(--color-border);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--color-primary);
            font-family: var(--font-heading);
        }
        
        .stat-label {
            color: var(--color-text-light);
            font-weight: 600;
            margin-top: 0.5rem;
        }
        
        .success-message,
        .error-message,
        .info-message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .success-message {
            background: var(--color-success);
            color: white;
        }
        
        .error-message {
            background: var(--color-error);
            color: white;
        }
        
        .info-message {
            background: #2196F3;
            color: white;
        }
        
        .success-message.show,
        .error-message.show,
        .info-message.show {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        .github-setup {
            background: #f0f7ff;
            border: 2px solid #0969da;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .github-setup h3 {
            color: #0969da;
            margin-bottom: 1rem;
        }
        
        .github-setup ol {
            margin-left: 1.5rem;
            line-height: 2;
        }
        
        .github-setup code {
            background: #fff;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-family: monospace;
        }
        
        .token-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 1rem;
        }
        
        .token-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .token-status.connected {
            background: #dcfce7;
            color: #166534;
        }
        
        .token-status.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <button class="logout-btn" id="logoutBtn">Wyloguj siƒô</button>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Wysy≈Çam zdjƒôcie do GitHub...</p>
        </div>
    </div>
    
    <div class="admin-container">
        <div class="admin-header">
            <h1>üõ†Ô∏è Panel Administratora</h1>
            <p>ZarzƒÖdzaj galeriƒÖ Babci Haliny</p>
        </div>
        
        <div class="admin-nav">
            <button class="admin-nav-btn active" data-section="dashboard">Panel G≈Ç√≥wny</button>
            <button class="admin-nav-btn" data-section="github-setup">Konfiguracja GitHub</button>
            <button class="admin-nav-btn" data-section="add-product">Dodaj Produkt</button>
            <button class="admin-nav-btn" data-section="manage-products">ZarzƒÖdzaj Produktami</button>
        </div>
        
        <!-- Dashboard -->
        <div class="admin-section active" id="dashboard">
            <h2>Statystyki</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalProducts">29</div>
                    <div class="stat-label">Ca≈Çkowita liczba produkt√≥w</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSerwety">16</div>
                    <div class="stat-label">Serwety</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalAniolki">4</div>
                    <div class="stat-label">Anio≈Çki</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalDekoracje">5</div>
                    <div class="stat-label">Dekoracje</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalDzieci">4</div>
                    <div class="stat-label">Dla Dzieci</div>
                </div>
            </div>
            
            <h3>Witaj w Panelu Administratora! üëã</h3>
            <p>Aby m√≥c automatycznie zapisywaƒá zdjƒôcia do GitHub, przejd≈∫ do sekcji <strong>"Konfiguracja GitHub"</strong> i skonfiguruj Personal Access Token.</p>
            
            <div class="token-input-group" style="margin-top: 1rem;">
                <span>Status po≈ÇƒÖczenia:</span>
                <span class="token-status disconnected" id="dashboardTokenStatus">‚ùå Nie skonfigurowano</span>
            </div>
        </div>
        
        <!-- GitHub Setup -->
        <div class="admin-section" id="github-setup">
            <h2>üîê Konfiguracja GitHub</h2>
            
            <div class="success-message" id="tokenSuccessMessage">
                ‚úÖ Token zosta≈Ç pomy≈õlnie zapisany!
            </div>
            
            <div class="github-setup">
                <h3>üìù Instrukcja konfiguracji GitHub Token</h3>
                <p>Aby automatycznie zapisywaƒá zdjƒôcia do repozytorium GitHub, wykonaj nastƒôpujƒÖce kroki:</p>
                
                <ol>
                    <li>Przejd≈∫ na <a href="https://github.com/settings/tokens" target="_blank" style="color: #0969da; font-weight: 600;">github.com/settings/tokens</a></li>
                    <li>Kliknij <strong>"Generate new token"</strong> ‚Üí <strong>"Generate new token (classic)"</strong></li>
                    <li>Nadaj nazwƒô tokenowi: <code>BabciaHalina Admin</code></li>
                    <li>Zaznacz nastƒôpujƒÖce uprawnienia:
                        <ul>
                            <li>‚úÖ <code>repo</code> (Full control of private repositories)</li>
                        </ul>
                    </li>
                    <li>Kliknij <strong>"Generate token"</strong> na dole strony</li>
                    <li>Skopiuj wygenerowany token (bƒôdzie widoczny tylko raz!)</li>
                    <li>Wklej token poni≈ºej i zapisz</li>
                </ol>
            </div>
            
            <div class="form-group">
                <label for="githubToken">GitHub Personal Access Token</label>
                <div class="token-input-group">
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" style="flex: 1;">
                    <button type="button" onclick="toggleTokenVisibility()" class="btn-edit">üëÅÔ∏è Poka≈º</button>
                </div>
            </div>
            
            <div class="token-input-group">
                <span>Status:</span>
                <span class="token-status disconnected" id="tokenStatus">‚ùå Nie skonfigurowano</span>
            </div>
            
            <button type="button" onclick="saveGithubToken()" class="submit-button" style="margin-top: 1rem;">Zapisz Token</button>
            
            <div style="margin-top: 2rem; padding: 1rem; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                <strong>‚ö†Ô∏è Wa≈ºne informacje o bezpiecze≈Ñstwie:</strong>
                <ul style="margin-left: 1.5rem; margin-top: 0.5rem; line-height: 1.8;">
                    <li>Token jest zapisywany tylko w Twojej przeglƒÖdarce (localStorage)</li>
                    <li>Nigdy nie udostƒôpniaj swojego tokenu nikomu</li>
                    <li>Token ma pe≈Çny dostƒôp do Twojego repozytorium</li>
                    <li>Mo≈ºesz usunƒÖƒá token w ka≈ºdej chwili na GitHub</li>
                </ul>
            </div>
        </div>
        
        <!-- Dodaj Produkt -->
        <div class="admin-section" id="add-product">
            <div class="success-message" id="successMessage">
                ‚úÖ Produkt zosta≈Ç pomy≈õlnie dodany do GitHub!
            </div>
            
            <div class="error-message" id="errorMessage">
                ‚ùå WystƒÖpi≈Ç b≈ÇƒÖd. Sprawd≈∫ konfiguracjƒô GitHub Token.
            </div>
            
            <div class="info-message" id="infoMessage">
                ‚ÑπÔ∏è Skonfiguruj GitHub Token w sekcji "Konfiguracja GitHub" aby automatycznie zapisywaƒá zdjƒôcia.
            </div>
            
            <h2>Dodaj Nowy Produkt</h2>
            <form id="addProductForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="productName">Nazwa produktu *</label>
                        <input type="text" id="productName" required>
                    </div>
                    <div class="form-group">
                        <label for="productCategory">Kategoria *</label>
                        <select id="productCategory" required>
                            <option value="">Wybierz kategoriƒô</option>
                            <option value="serwety">Serwety</option>
                            <option value="aniolki">Anio≈Çki</option>
                            <option value="dekoracje">Dekoracje</option>
                            <option value="dzieci">Dla Dzieci</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="productDescription">Opis produktu *</label>
                    <textarea id="productDescription" rows="4" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="productImageFile">Zdjƒôcie produktu * (zostanie automatycznie zapisane w GitHub)</label>
                    <input type="file" id="productImageFile" accept="image/*" required>
                    <img id="imagePreview" class="image-preview" style="display: none;" alt="PodglƒÖd">
                </div>
                
                <div class="form-group">
                    <label for="productStatus">Status</label>
                    <select id="productStatus">
                        <option value="Na Zam√≥wienie">Na Zam√≥wienie</option>
                        <option value="Dostƒôpny">Dostƒôpny</option>
                        <option value="Wyprzedany">Wyprzedany</option>
                    </select>
                </div>
                
                <button type="submit" class="submit-button">üì§ Dodaj Produkt i Wy≈õlij do GitHub</button>
            </form>
        </div>
        
        <!-- ZarzƒÖdzaj Produktami -->
        <div class="admin-section" id="manage-products">
            <h2>ZarzƒÖdzaj Produktami</h2>
            <p style="color: var(--color-text-light); margin-bottom: 1rem;">Uwaga: Edycja i usuwanie produkt√≥w wymaga rƒôcznej aktualizacji pliku script.js w repozytorium.</p>
            <div class="product-list" id="productList">
                <p>Lista produkt√≥w jest wy≈õwietlana na stronie g≈Ç√≥wnej. Nowe produkty dodane przez panel bƒôdƒÖ automatycznie zapisane w GitHub.</p>
            </div>
        </div>
    </div>
    
    <script>
        // Sprawdzenie autoryzacji
        if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
            window.location.href = 'index.html';
        }
        
        // Konfiguracja GitHub
        const GITHUB_OWNER = 'Bunnycukino';
        const GITHUB_REPO = 'BabciaHalina.com';
        const GITHUB_BRANCH = 'main';
        
        // Sprawdzanie tokenu przy ≈Çadowaniu
        function checkTokenStatus() {
            const token = localStorage.getItem('githubToken');
            const statusElements = [document.getElementById('tokenStatus'), document.getElementById('dashboardTokenStatus')];
            
            if (token) {
                statusElements.forEach(el => {
                    if (el) {
                        el.className = 'token-status connected';
                        el.textContent = '‚úÖ Skonfigurowano';
                    }
                });
                return true;
            } else {
                statusElements.forEach(el => {
                    if (el) {
                        el.className = 'token-status disconnected';
                        el.textContent = '‚ùå Nie skonfigurowano';
                    }
                });
                return false;
            }
        }
        
        // Zapisywanie tokenu
        function saveGithubToken() {
            const token = document.getElementById('githubToken').value.trim();
            
            if (!token) {
                alert('‚ùå Proszƒô wprowadziƒá token!');
                return;
            }
            
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                alert('‚ö†Ô∏è Token powinien zaczynaƒá siƒô od "ghp_" lub "github_pat_". Sprawd≈∫ czy skopiowa≈Çe≈õ poprawny token.');
                return;
            }
            
            localStorage.setItem('githubToken', token);
            
            const successMsg = document.getElementById('tokenSuccessMessage');
            successMsg.classList.add('show');
            setTimeout(() => successMsg.classList.remove('show'), 3000);
            
            checkTokenStatus();
            alert('‚úÖ Token zosta≈Ç zapisany! Mo≈ºesz teraz dodawaƒá zdjƒôcia.');
        }
        
        // Prze≈ÇƒÖczanie widoczno≈õci tokenu
        function toggleTokenVisibility() {
            const input = document.getElementById('githubToken');
            input.type = input.type === 'password' ? 'text' : 'password';
        }
        
        // Konwersja pliku do Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }
        
        // Upload zdjƒôcia do GitHub
        async function uploadImageToGithub(file, productName) {
            const token = localStorage.getItem('githubToken');
            
            if (!token) {
                throw new Error('Brak tokenu GitHub. Skonfiguruj token w sekcji "Konfiguracja GitHub".');
            }
            
            const base64Content = await fileToBase64(file);
            const fileName = `IMG_${Date.now()}.${file.name.split('.').pop()}`;
            const path = `assets/produkty/${fileName}`;
            
            const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${path}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: `Dodanie zdjƒôcia produktu: ${productName}`,
                    content: base64Content,
                    branch: GITHUB_BRANCH
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'B≈ÇƒÖd podczas wysy≈Çania zdjƒôcia');
            }
            
            const data = await response.json();
            return path;
        }
        
        // Aktualizacja script.js z nowym produktem
        async function updateScriptJS(newProduct) {
            const token = localStorage.getItem('githubToken');
            
            // Pobierz aktualny plik script.js
            const getResponse = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/script.js`, {
                headers: {
                    'Authorization': `token ${token}`
                }
            });
            
            const fileData = await getResponse.json();
            const currentContent = atob(fileData.content);
            
            // Znajd≈∫ miejsce gdzie sƒÖ produkty i dodaj nowy
            const productToAdd = `    {
        id: ${newProduct.id},
        name: "${newProduct.name}",
        description: "${newProduct.description}",
        image: "${newProduct.image}",
        status: "${newProduct.status}",
        category: "${newProduct.category}"
    }`;
            
            // Znajd≈∫ ostatni produkt i dodaj nowy przed zamkniƒôciem tablicy
            const lastProductIndex = currentContent.lastIndexOf('}\n];');
            const updatedContent = currentContent.substring(0, lastProductIndex) + '},\n' + productToAdd + '\n];' + currentContent.substring(lastProductIndex + 3);
            
            // Wy≈õlij zaktualizowany plik
            const updateResponse = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/script.js`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: `Dodanie produktu: ${newProduct.name}`,
                    content: btoa(unescape(encodeURIComponent(updatedContent))),
                    sha: fileData.sha,
                    branch: GITHUB_BRANCH
                })
            });
            
            if (!updateResponse.ok) {
                throw new Error('B≈ÇƒÖd podczas aktualizacji script.js');
            }
        }
        
        // Nawigacja miƒôdzy sekcjami
        document.querySelectorAll('.admin-nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.admin-nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
                const sectionId = btn.dataset.section;
                document.getElementById(sectionId).classList.add('active');
            });
        });
        
        // Wylogowanie
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm('Czy na pewno chcesz siƒô wylogowaƒá?')) {
                sessionStorage.removeItem('adminLoggedIn');
                window.location.href = 'index.html';
            }
        });
        
        // PodglƒÖd zdjƒôcia
        document.getElementById('productImageFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Dodawanie produktu
        document.getElementById('addProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Sprawd≈∫ czy token jest skonfigurowany
            if (!localStorage.getItem('githubToken')) {
                const infoMsg = document.getElementById('infoMessage');
                infoMsg.classList.add('show');
                setTimeout(() => infoMsg.classList.remove('show'), 5000);
                return;
            }
            
            const file = document.getElementById('productImageFile').files[0];
            if (!file) {
                alert('‚ùå Proszƒô wybraƒá zdjƒôcie!');
                return;
            }
            
            const productName = document.getElementById('productName').value;
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            try {
                loadingOverlay.classList.add('active');
                
                // 1. Wy≈õlij zdjƒôcie do GitHub
                const imagePath = await uploadImageToGithub(file, productName);
                
                // 2. Utw√≥rz nowy produkt
                const newProduct = {
                    id: Date.now(),
                    name: productName,
                    description: document.getElementById('productDescription').value,
                    category: document.getElementById('productCategory').value,
                    status: document.getElementById('productStatus').value,
                    image: imagePath
                };
                
                // 3. Zaktualizuj script.js
                await updateScriptJS(newProduct);
                
                loadingOverlay.classList.remove('active');
                
                // Poka≈º komunikat sukcesu
                const successMsg = document.getElementById('successMessage');
                successMsg.classList.add('show');
                setTimeout(() => successMsg.classList.remove('show'), 5000);
                
                // Reset formularza
                e.target.reset();
                document.getElementById('imagePreview').style.display = 'none';
                
                alert('üéâ Sukces! Produkt zosta≈Ç dodany do GitHub. Od≈õwie≈º stronƒô g≈Ç√≥wnƒÖ aby zobaczyƒá zmiany.');
                
            } catch (error) {
                loadingOverlay.classList.remove('active');
                console.error('B≈ÇƒÖd:', error);
                
                const errorMsg = document.getElementById('errorMessage');
                errorMsg.textContent = `‚ùå B≈ÇƒÖd: ${error.message}`;
                errorMsg.classList.add('show');
                setTimeout(() => errorMsg.classList.remove('show'), 5000);
            }
        });
        
        // Inicjalizacja
        checkTokenStatus();
    </script>
</body>
</html>