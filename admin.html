<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administratora | Babcia Halina</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container { max-width: 1200px; margin: 100px auto 50px; padding: 2rem; }
        .admin-header { background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark)); color: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; text-align: center; }
        .admin-header h1 { color: white; margin-bottom: 0.5rem; }
        .admin-nav { display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .admin-nav-btn { flex: 1; min-width: 150px; padding: 1rem; background: white; border: 2px solid var(--color-border); border-radius: 8px; font-weight: 600; transition: all 0.3s; }
        .admin-nav-btn:hover, .admin-nav-btn.active { background: var(--color-primary); color: white; border-color: var(--color-primary); }
        .admin-section { display: none; background: white; padding: 2rem; border-radius: 12px; box-shadow: var(--shadow-md); }
        .admin-section.active { display: block; animation: fadeIn 0.3s; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .image-preview { max-width: 300px; margin: 1rem 0; border-radius: 8px; box-shadow: var(--shadow-sm); }
        .logout-btn { position: fixed; top: 90px; right: 2rem; padding: 0.7rem 1.5rem; background: var(--color-error); color: white; border-radius: 25px; font-weight: 600; z-index: 100; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: var(--color-background-alt); padding: 1.5rem; border-radius: 12px; text-align: center; border: 2px solid var(--color-border); }
        .stat-number { font-size: 2.5rem; font-weight: 700; color: var(--color-primary); font-family: var(--font-heading); }
        .stat-label { color: var(--color-text-light); font-weight: 600; margin-top: 0.5rem; }
        .success-message, .error-message, .info-message { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: none; }
        .success-message { background: var(--color-success); color: white; }
        .error-message { background: var(--color-error); color: white; }
        .info-message { background: #2196F3; color: white; }
        .success-message.show, .error-message.show, .info-message.show { display: block; animation: fadeIn 0.3s; }
        .github-setup { background: #f0f7ff; border: 2px solid #0969da; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; }
        .github-setup h3 { color: #0969da; margin-bottom: 1rem; }
        .github-setup ol { margin-left: 1.5rem; line-height: 2; }
        .github-setup code { background: #fff; padding: 0.2rem 0.5rem; border-radius: 4px; border: 1px solid #ddd; font-family: monospace; }
        .token-input-group { display: flex; gap: 0.5rem; align-items: center; margin-top: 1rem; }
        .token-status { padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600; }
        .token-status.connected { background: #dcfce7; color: #166534; }
        .token-status.disconnected { background: #fee2e2; color: #991b1b; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 9999; align-items: center; justify-content: center; }
        .loading-overlay.active { display: flex; }
        .loading-content { background: white; padding: 2rem; border-radius: 12px; text-align: center; max-width: 400px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--color-primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .debug-info { background: #f5f5f5; padding: 1rem; border-radius: 8px; margin-top: 1rem; font-family: monospace; font-size: 0.85rem; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <button class="logout-btn" id="logoutBtn">Wyloguj</button>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingText">Wysy≈Çam zdjƒôcie do GitHub...</p>
            <p id="loadingProgress" style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;"></p>
        </div>
    </div>
    
    <div class="admin-container">
        <div class="admin-header">
            <h1>üõ†Ô∏è Panel Administratora</h1>
            <p>ZarzƒÖdzaj galeriƒÖ Babci Haliny</p>
        </div>
        
        <div class="admin-nav">
            <button class="admin-nav-btn active" data-section="dashboard">Panel</button>
            <button class="admin-nav-btn" data-section="github-setup">GitHub</button>
            <button class="admin-nav-btn" data-section="add-product">Dodaj</button>
        </div>
        
        <div class="admin-section active" id="dashboard">
            <h2>Status Systemu</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalProducts">29</div>
                    <div class="stat-label">Produkt√≥w</div>
                </div>
            </div>
            <div class="token-input-group">
                <span>Po≈ÇƒÖczenie GitHub:</span>
                <span class="token-status disconnected" id="dashboardTokenStatus">‚ùå Brak</span>
            </div>
            <p style="margin-top: 1rem;">Aby dodaƒá zdjƒôcia, skonfiguruj token w sekcji <strong>GitHub</strong>.</p>
        </div>
        
        <div class="admin-section" id="github-setup">
            <h2>üîê Konfiguracja GitHub</h2>
            <div class="success-message" id="tokenSuccessMessage">‚úÖ Token zapisany!</div>
            
            <div class="github-setup">
                <h3>Instrukcja (5 krok√≥w)</h3>
                <ol>
                    <li>Otw√≥rz: <a href="https://github.com/settings/tokens" target="_blank" style="color: #0969da;">github.com/settings/tokens</a></li>
                    <li>Kliknij <strong>Generate new token (classic)</strong></li>
                    <li>Nazwa: <code>BabciaHalina</code></li>
                    <li>Zaznacz: <code>repo</code> (wszystkie)</li>
                    <li>Kliknij <strong>Generate token</strong> i skopiuj</li>
                </ol>
            </div>
            
            <div class="form-group">
                <label>GitHub Token</label>
                <div class="token-input-group">
                    <input type="password" id="githubToken" placeholder="ghp_xxxx" style="flex: 1;">
                    <button type="button" onclick="toggleToken()" class="btn-edit">üëÅÔ∏è</button>
                </div>
            </div>
            
            <div class="token-input-group">
                <span>Status:</span>
                <span class="token-status disconnected" id="tokenStatus">‚ùå Brak</span>
            </div>
            
            <button onclick="saveToken()" class="submit-button" style="margin-top: 1rem;">Zapisz Token</button>
        </div>
        
        <div class="admin-section" id="add-product">
            <div class="success-message" id="successMessage">‚úÖ Produkt dodany!</div>
            <div class="error-message" id="errorMessage">‚ùå B≈ÇƒÖd</div>
            <div class="info-message" id="infoMessage">‚ÑπÔ∏è Najpierw skonfiguruj GitHub Token</div>
            
            <h2>Dodaj Produkt</h2>
            <form id="addProductForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nazwa *</label>
                        <input type="text" id="productName" required>
                    </div>
                    <div class="form-group">
                        <label>Kategoria *</label>
                        <select id="productCategory" required>
                            <option value="">Wybierz</option>
                            <option value="serwety">Serwety</option>
                            <option value="aniolki">Anio≈Çki</option>
                            <option value="dekoracje">Dekoracje</option>
                            <option value="dzieci">Dla Dzieci</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Opis *</label>
                    <textarea id="productDescription" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label>Zdjƒôcie * (max 5MB)</label>
                    <input type="file" id="productImageFile" accept="image/*" required>
                    <img id="imagePreview" class="image-preview" style="display: none;">
                    <p id="fileInfo" style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;"></p>
                </div>
                
                <button type="submit" class="submit-button">üì§ Dodaj do GitHub</button>
            </form>
            
            <div id="debugInfo" class="debug-info" style="display: none;"></div>
        </div>
    </div>
    
    <script>
        if (sessionStorage.getItem('adminLoggedIn') !== 'true') window.location.href = 'index.html';
        
        const GITHUB_OWNER = 'Bunnycukino';
        const GITHUB_REPO = 'BabciaHalina.com';
        const GITHUB_BRANCH = 'main';
        
        function log(msg) {
            console.log(msg);
            const debug = document.getElementById('debugInfo');
            if (debug) {
                debug.style.display = 'block';
                debug.innerHTML += `${new Date().toLocaleTimeString()}: ${msg}<br>`;
            }
        }
        
        function checkTokenStatus() {
            const token = localStorage.getItem('githubToken');
            const els = [document.getElementById('tokenStatus'), document.getElementById('dashboardTokenStatus')];
            els.forEach(el => {
                if (el) {
                    if (token) {
                        el.className = 'token-status connected';
                        el.textContent = '‚úÖ Po≈ÇƒÖczono';
                    } else {
                        el.className = 'token-status disconnected';
                        el.textContent = '‚ùå Brak';
                    }
                }
            });
            return !!token;
        }
        
        function saveToken() {
            const token = document.getElementById('githubToken').value.trim();
            if (!token) { alert('‚ùå Wpisz token!'); return; }
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                alert('‚ö†Ô∏è Token powinien zaczynaƒá siƒô od "ghp_"');
                return;
            }
            localStorage.setItem('githubToken', token);
            document.getElementById('tokenSuccessMessage').classList.add('show');
            setTimeout(() => document.getElementById('tokenSuccessMessage').classList.remove('show'), 3000);
            checkTokenStatus();
            alert('‚úÖ Token zapisany!');
        }
        
        function toggleToken() {
            const inp = document.getElementById('githubToken');
            inp.type = inp.type === 'password' ? 'text' : 'password';
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }
        
        async function uploadImage(file, name) {
            const token = localStorage.getItem('githubToken');
            if (!token) throw new Error('Brak tokenu');
            
            log(`Rozpoczynam upload: ${file.name} (${(file.size/1024).toFixed(0)}KB)`);
            document.getElementById('loadingProgress').textContent = 'Konwertujƒô zdjƒôcie...';
            
            const base64 = await fileToBase64(file);
            log('Zdjƒôcie skonwertowane do base64');
            
            const fileName = `IMG_${Date.now()}.${file.name.split('.').pop()}`;
            const path = `assets/produkty/${fileName}`;
            
            document.getElementById('loadingProgress').textContent = 'Wysy≈Çam do GitHub...';
            log(`Wysy≈Çam: ${path}`);
            
            const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${path}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: `Dodanie: ${name}`,
                    content: base64,
                    branch: GITHUB_BRANCH
                })
            });
            
            log(`Response status: ${response.status}`);
            
            if (!response.ok) {
                const err = await response.json();
                log(`B≈ÇƒÖd API: ${JSON.stringify(err)}`);
                throw new Error(err.message || `HTTP ${response.status}`);
            }
            
            log('Upload sukces!');
            return path;
        }
        
        async function updateScript(product) {
            const token = localStorage.getItem('githubToken');
            document.getElementById('loadingProgress').textContent = 'Aktualizujƒô listƒô produkt√≥w...';
            log('Pobieram script.js...');
            
            const getResp = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/script.js`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            const data = await getResp.json();
            const content = atob(data.content);
            
            const newProd = `    { id: ${product.id}, name: "${product.name}", description: "${product.description}", image: "${product.image}", status: "${product.status}", category: "${product.category}" }`;
            const idx = content.lastIndexOf('}\n];');
            const updated = content.substring(0, idx) + '},\n' + newProd + '\n];' + content.substring(idx + 3);
            
            log('Zapisujƒô zaktualizowany script.js...');
            
            const putResp = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/script.js`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: `Dodano: ${product.name}`,
                    content: btoa(unescape(encodeURIComponent(updated))),
                    sha: data.sha,
                    branch: GITHUB_BRANCH
                })
            });
            
            if (!putResp.ok) throw new Error('B≈ÇƒÖd aktualizacji script.js');
            log('Script.js zaktualizowany!');
        }
        
        document.querySelectorAll('.admin-nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.admin-nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
                document.getElementById(btn.dataset.section).classList.add('active');
            });
        });
        
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm('Wylogowaƒá?')) {
                sessionStorage.removeItem('adminLoggedIn');
                window.location.href = 'index.html';
            }
        });
        
        document.getElementById('productImageFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const sizeKB = (file.size / 1024).toFixed(0);
                const sizeMB = (file.size / 1024 / 1024).toFixed(2);
                document.getElementById('fileInfo').textContent = `Plik: ${file.name} (${sizeKB}KB = ${sizeMB}MB)`;
                
                if (file.size > 5 * 1024 * 1024) {
                    alert('‚ö†Ô∏è Zdjƒôcie jest za du≈ºe! Max 5MB. Spr√≥buj zmniejszyƒá jako≈õƒá lub rozmiar.');
                    e.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
        
        document.getElementById('addProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!checkTokenStatus()) {
                document.getElementById('infoMessage').classList.add('show');
                setTimeout(() => document.getElementById('infoMessage').classList.remove('show'), 5000);
                return;
            }
            
            const file = document.getElementById('productImageFile').files[0];
            if (!file) { alert('‚ùå Wybierz zdjƒôcie!'); return; }
            
            const name = document.getElementById('productName').value;
            const loading = document.getElementById('loadingOverlay');
            
            try {
                loading.classList.add('active');
                document.getElementById('debugInfo').innerHTML = '';
                log('START: Dodawanie produktu');
                
                const imagePath = await uploadImage(file, name);
                
                const product = {
                    id: Date.now(),
                    name: name,
                    description: document.getElementById('productDescription').value,
                    category: document.getElementById('productCategory').value,
                    status: 'Na Zam√≥wienie',
                    image: imagePath
                };
                
                await updateScript(product);
                
                loading.classList.remove('active');
                document.getElementById('successMessage').classList.add('show');
                setTimeout(() => document.getElementById('successMessage').classList.remove('show'), 5000);
                
                e.target.reset();
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('fileInfo').textContent = '';
                
                alert('üéâ SUKCES! Produkt dodany. Od≈õwie≈º stronƒô g≈Ç√≥wnƒÖ!');
                log('KONIEC: Sukces!');
                
            } catch (error) {
                loading.classList.remove('active');
                log(`B≈ÅƒÑD: ${error.message}`);
                const errorMsg = document.getElementById('errorMessage');
                errorMsg.textContent = `‚ùå B≈ÇƒÖd: ${error.message}`;
                errorMsg.classList.add('show');
                setTimeout(() => errorMsg.classList.remove('show'), 10000);
                alert(`‚ùå B≈ÇƒÖd: ${error.message}\n\nSprawd≈∫ debug info poni≈ºej formularza.`);
            }
        });
        
        checkTokenStatus();
    </script>
</body>
</html>